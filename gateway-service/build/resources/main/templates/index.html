<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>MSA 프로젝트 - The Cafe</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/common.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        /* 1. 히어로(Hero) 섹션 스타일 (기존 배경 유지) */
        .hero-section {
            /* 배경 이미지 변경: 원두 가공/로스팅 이미지 URL 적용 */
            background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)),
            url('https://images.unsplash.com/photo-1509042239860-f550ce710b93?q=80&w=1920&auto=format&fit=crop');

            background-size: cover; /* 이미지가 영역을 꽉 채우도록 */
            background-position: center; /* 이미지의 중앙을 보여줌 */
            background-attachment: fixed; /* (선택) 스크롤 할 때 배경은 고정되어 고급스러운 느낌 */

            height: 80vh; /* 화면 높이의 60% */
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); /* 글자가 잘 보이도록 그림자 진하게 */
        }

        /* 2. 커피 테마 버튼 (갈색) */
        .btn-coffee {
            background-color: #6f4e37; /* Coffee Brown */
            color: white;
            font-weight: bold;
            border: none;
        }
        .btn-coffee:hover {
            background-color: #5a3f2d;
            color: white;
        }

        /* 3. 카드 섹션 스타일 */
        .card {
            border: none;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-5px); /* 살짝 떠오르는 효과 */
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        .card-icon {
            font-size: 3rem; /* 48px */
            color: #6f4e37; /* Coffee Brown */
        }

    </style>
</head>
<body>

<div th:replace="~{fragments/navbar :: navbarFragment}"></div>

<div class="hero-section text-center">
    <div class="container">
        <h1 class="display-3 fw-bold">The MSA Cafe</h1>
        <p class="lead fs-4">마이크로서비스 아키텍처로 구현된 커피 주문 프로젝트입니다.</p>
        <a href="/orders" class="btn btn-coffee btn-lg m-2">
            <i class="bi bi-cart-check"></i> 지금 주문하기
        </a>
        <a href="/menus" class="btn btn-outline-light btn-lg m-2">
            <i class="bi bi-book"></i> 메뉴 관리
        </a>
    </div>
</div>

<div class="container mt-5 mb-5">
    <h2 class="text-center mb-4" style="color: #4a342e; font-weight: 800;">주요 기능</h2>
    <div class="row g-4">

        <div class="col-md-4">
            <div class="card h-100 text-center shadow-sm p-4">
                <div class="card-body">
                    <div class="card-icon mb-3"><i class="bi bi-journal-plus"></i></div>
                    <h5 class="card-title fw-bold">동적 메뉴 관리</h5>
                    <p class="card-text text-muted">실시간으로 메뉴와 옵션을 추가, 수정, 삭제합니다. (Menu Service)</p>
                    <a href="/menus" class="btn btn-coffee mt-2">메뉴 관리로 이동</a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card h-100 text-center shadow-sm p-4">
                <div class="card-body">
                    <div class="card-icon mb-3"><i class="bi bi-bar-chart-line-fill"></i></div>
                    <h5 class="card-title fw-bold">실시간 주문 현황</h5>
                    <p class="card-text text-muted">10초마다 자동으로 업데이트되는 주문 대시보드입니다. (Order Service)</p>
                    <a href="/dashboard" class="btn btn-coffee mt-2">대시보드로 이동</a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card h-100 text-center shadow-sm p-4">
                <div class="card-body">
                    <div class="card-icon mb-3"><i class="bi bi-box-seam-fill"></i></div>
                    <h5 class="card-title fw-bold">분산 재고 관리</h5>
                    <p class="card-text text-muted">주문 시 Feign Client를 통해 재고를 차감합니다. (Stock Service)</p>
                    <a href="/stocks" class="btn btn-coffee mt-2">재고 관리로 이동</a>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ★★★ [핵심] 네비게이션 바 불러오기 함수 ★★★
    async function loadNavbar() {
        try {
            const response = await fetch('/navbar.html'); // navbar.html 파일 경로
            const html = await response.text();
            document.getElementById('navbar-placeholder').innerHTML = html;

            // 네비바 로딩이 완료된 후에 로그인 상태 체크 실행
            checkLoginStatus();
        } catch (error) {
            console.error('네비게이션 바 로딩 실패:', error);
        }
    }
    /* -------------------------------
       로그인 상태 체크
    --------------------------------*/
    function checkLoginStatus() {
        const token = localStorage.getItem("token");
        const username = localStorage.getItem("username");
        const role = localStorage.getItem("role");

        // 요소가 존재하는지 먼저 확인 (안전장치)
        const loginNav = document.getElementById("loginNav");
        if (!loginNav) return; // 네비바가 아직 없으면 중단

        if (token && username) {
            loginNav.classList.add("d-none");
            document.getElementById("registerNav").classList.add("d-none");
            document.getElementById("userNav").classList.remove("d-none");
            document.getElementById("logoutNav").classList.remove("d-none");
            document.getElementById("changePasswordNav").classList.remove("d-none");
            document.getElementById("username").textContent = `${username} (${role})`;
        } else {
            loginNav.classList.remove("d-none");
            document.getElementById("registerNav").classList.remove("d-none");
            document.getElementById("userNav").classList.add("d-none");
            document.getElementById("logoutNav").classList.add("d-none");
            document.getElementById("changePasswordNav").classList.add("d-none");
        }
    }


    /* -------------------------------
       모달 표기 공통 함수
    --------------------------------*/
    function showModal(title, message, showLoginBtn = true) {
        document.getElementById("loginModalLabel").textContent = title;
        document.getElementById("modalMessage").textContent = message;

        const loginBtn = document.getElementById("goToLogin");

        if (showLoginBtn) loginBtn.classList.remove("d-none");
        else loginBtn.classList.add("d-none");

        const modalEl = document.getElementById("loginModal");
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
    }


    /* -------------------------------
       관리자 접근 체크 (핵심)
    --------------------------------*/
    function checkAdminAccess(targetUrl) {
        const token = localStorage.getItem("token");
        const username = localStorage.getItem("username");
        const role = localStorage.getItem("role");

        if (!token || !username) {
            showModal("로그인 필요", "로그인이 필요합니다. 로그인 페이지로 이동하시겠습니까?", true);
            return;
        }

        if (role !== "ADMIN") {
            showModal("접근 불가", "관리자만 이용할 수 있는 메뉴입니다.", false);
            return;
        }

        window.location.href = targetUrl;
    }


    /* -------------------------------
       네비게이션 메뉴 클릭 처리
    --------------------------------*/
    function bindMenuEvents() {
        const adminPages = ["menuLink", "stockLink", "dashLink", "customerLink"];
        const loginOnlyPages = ["orderLink", "listLink"];

        // document 전체에 클릭 이벤트 리스너를 하나만 등록
        document.addEventListener('click', function(e) {
            const targetId = e.target.id;

            // 관리자 권한 체크 메뉴 클릭 시
            if (adminPages.includes(targetId)) {
                e.preventDefault();
                checkAdminAccess(e.target.getAttribute("href"));
            }

            // 로그인만 필요 메뉴 클릭 시
            if (loginOnlyPages.includes(targetId)) {
                e.preventDefault();
                const token = localStorage.getItem("token");
                const username = localStorage.getItem("username");
                if (!token || !username) {
                    showModal("로그인 필요", "로그인이 필요합니다. 로그인 페이지로 이동하시겠습니까?", true);
                } else {
                    window.location.href = e.target.getAttribute("href");
                }
            }

            // 로그아웃 버튼 클릭 시
            if (targetId === 'logoutBtn') {
                e.preventDefault();
                localStorage.removeItem("token");
                localStorage.removeItem("username");
                localStorage.removeItem("role");
                window.location.href = "/";
            }
        });
    }

    // 초기화 실행
    document.addEventListener("DOMContentLoaded", () => {
        loadNavbar(); // 네비게이션 바 불러오기 시작
        bindMenuEvents(); // 이벤트 위임 설정

        // Hero 주문 버튼 (네비바와 상관없으므로 기존 방식 유지)
        const heroOrderBtn = document.getElementById("heroOrderBtn");
        if (heroOrderBtn) {
            heroOrderBtn.addEventListener("click", (e) => {
                e.preventDefault();
                const token = localStorage.getItem("token");
                const username = localStorage.getItem("username");
                if (!token || !username) {
                    showModal("로그인 필요", "로그인이 필요합니다. 로그인 페이지로 이동하시겠습니까?", true);
                } else {
                    window.location.href = "/orders";
                }
            });
        }
    });

    // 로그인 페이지 이동 버튼
    document.getElementById("goToLogin").addEventListener("click", () => {
        window.location.href = "/login";
    });

</script>
</body>
</html>