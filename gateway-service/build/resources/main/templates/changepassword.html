<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>비밀번호 변경</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .container { max-width: 400px; margin: 50px auto; }
        input { width: 100%; padding: 10px; margin: 10px 0; }
        button { padding: 10px 20px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 5px; text-align: center; }
    </style>
</head>
<body>
<div class="container">
    <h2>비밀번호 변경</h2>
    <!-- 사용자명 필드를 자동으로 채워넣기 위해 값을 설정 -->
    <input type="text" id="username" placeholder="사용자명" readonly>
    <input type="password" id="oldPassword" placeholder="현재 비밀번호">
    <input type="password" id="newPassword" placeholder="새 비밀번호">
    <button id="changeBtn">변경</button>
</div>

<!-- 모달 -->
<div class="modal" id="resultModal">
    <div class="modal-content">
        <p id="modalMessage"></p>
        <button id="modalOk">확인</button>
    </div>
</div>

<script>
    $(document).ready(function(){
        // 페이지 로드 시 로그인된 사용자 정보 가져오기
        const username = localStorage.getItem('username');

        // 만약 로그인된 사용자가 있다면, 자동으로 사용자명 입력
        if (username) {
            $("#username").val(username);
        }

        $("#changeBtn").click(function(){
            const username = $("#username").val();
            const oldPassword = $("#oldPassword").val();
            const newPassword = $("#newPassword").val();

            // 사용자명과 비밀번호 입력 여부 확인
            if(!username || !oldPassword || !newPassword){
                alert("모든 칸을 입력해주세요.");
                return;
            }

            // 비밀번호 변경 요청
            $.ajax({
                url: "/api/auth/changepassword",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ username, oldPassword, newPassword }),
                success: function(message){
                    $("#modalMessage").text(message);
                    $("#resultModal").css("display", "flex");
                },
                error: function(xhr){
                    $("#modalMessage").text(xhr.responseText);
                    $("#resultModal").css("display", "flex");
                }
            });
        });

        // 모달의 확인 버튼 클릭 시
        $("#modalOk").click(function(){
            $("#resultModal").hide();
            window.location.href = "/";  // 비밀번호 변경 후 리디렉션
        });
    });
</script>
</body>
</html>
