<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>고객 관리</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar">
    <a href="/" class="navbar-brand">MSA Demo</a>
</nav>

<div class="container mt-4">
    <div class="card">
        <div class="d-flex justify-content-between align-items-center mb-4 p-3">
            <h2>고객 관리</h2>
            <button class="btn btn-primary" onclick="showAddCustomerModal()">고객 추가</button>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>고객명</th>
                    <th>상품명</th>
                    <th>전화번호</th>
                    <th>주문일시</th>
                    <th>가격</th>
                    <th>상품 수량</th>
                    <th>상태</th>
                    <th>작업</th>
                </tr>
                </thead>
                <tbody id="productTableBody">
                <!-- 고객 목록이 동적으로 삽입될 곳 -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 고객 추가/수정 모달 -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">고객 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId"> <!-- 고객 ID -->

                    <!-- 고객명 -->
                    <div class="mb-3">
                        <label class="form-label" for="customerName">고객명</label>
                        <input type="text" class="form-control" id="customerName" required>
                    </div>

                    <!-- 상품명 -->
                    <div class="mb-3">
                        <label class="form-label" for="productName">상품명</label>
                        <textarea class="form-control" id="productName" required style="height: calc(2.25rem + 2px);"></textarea>
                    </div>

                    <!-- 전화번호 -->
                    <div class="mb-3">
                        <label class="form-label" for="customerPhone">전화번호</label>
                        <input type="tel" class="form-control" id="customerPhone" placeholder="010-1234-5678" required>
                        <small class="text-muted">예: 010-1234-5678</small>
                    </div>

                    <!-- 주문일시 -->
                    <div class="mb-3">
                        <label class="form-label" for="orderDate">주문일시</label>
                        <input type="datetime-local" class="form-control" id="orderDate" required>
                    </div>

                    <!-- 가격 -->
                    <div class="mb-3">
                        <label class="form-label" for="totalPrice">가격</label>
                        <input type="text" class="form-control" id="totalPrice" required>
                    </div>

                    <!-- 상품 수량 -->
                    <div class="mb-3">
                        <label class="form-label" for="quantity">상품 수량</label>
                        <input type="number" class="form-control" id="quantity" required min="1">
                    </div>

                    <!-- 상태 -->
                    <div class="mb-3">
                        <label class="form-label" for="status">상태</label>
                        <select class="form-control" id="status" required>
                            <option value="ORDERED">주문됨</option>
                            <option value="SHIPPED">배송 중</option>
                            <option value="DELIVERED">배송 완료</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="saveCustomer()">저장</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // 로그인 상태 확인
    function checkLoginStatus() {
        const token = localStorage.getItem('token');
        const username = localStorage.getItem('username');
        const role = localStorage.getItem('role');

        if (token && username) {
            document.getElementById('userNav').classList.remove('d-none');
            document.getElementById('logoutNav').classList.remove('d-none');
            document.getElementById('username').textContent = `${username} (${role})`;

            if (role === 'ADMIN') {
                // 관리자인 경우 고객 관리 페이지로 리다이렉트
                window.location.href = '/customers';  // 관리자 페이지로 리다이렉트
            } else {
                window.location.href = '/';
            }
        } else {
            window.location.href = '/login';
        }
    }



    // 모달 열기 함수 (제목을 "고객 추가"로 세팅)
    function showAddCustomerModal() {
        document.getElementById('modalTitle').textContent = '고객 추가';

        // 폼 초기화
        document.getElementById('productForm').reset();
        document.getElementById('productId').value = '';

        // Bootstrap 모달 열기
        const productModal = new bootstrap.Modal(document.getElementById('productModal'));
        productModal.show();
    }

    // 저장 버튼 동작 (신규 추가 및 수정 처리)
    function saveCustomer() {
        const form = document.getElementById('productForm');

        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        // 입력값 읽기
        const id = document.getElementById('productId').value || generateUniqueId(); // 새 항목이면 새 id 생성
        const customerName = document.getElementById('customerName').value.trim();
        const productName = document.getElementById('productName').value.trim();
        const customerPhone = document.getElementById('customerPhone').value.trim();
        const orderDate = document.getElementById('orderDate').value;
        const totalPrice = document.getElementById('totalPrice').value.trim();
        const quantity = document.getElementById('quantity').value.trim();
        const status = document.getElementById('status').value;

        const tbody = document.getElementById('productTableBody');

        // 기존 행 수정인지 확인
        let existingRow = null;
        for (const row of tbody.rows) {
            if (row.cells[0].textContent === id) {
                existingRow = row;
                break;
            }
        }

        if (existingRow) {
            // 수정할 경우 기존 행 업데이트
            existingRow.cells[1].textContent = customerName;
            existingRow.cells[2].textContent = productName;
            existingRow.cells[3].textContent = customerPhone;
            existingRow.cells[4].textContent = orderDate.replace('T', ' ');
            existingRow.cells[5].textContent = totalPrice;
            existingRow.cells[6].textContent = quantity;
            existingRow.cells[7].textContent = getStatusText(status);
        } else {
            // 새 행 생성
            const tr = document.createElement('tr');

            tr.innerHTML = `
                <td>${id}</td>
                <td>${customerName}</td>
                <td>${productName}</td>
                <td>${customerPhone}</td>
                <td>${orderDate.replace('T', ' ')}</td>
                <td>${totalPrice}</td>
                <td>${quantity}</td>
                <td>${getStatusText(status)}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="editCustomer('${id}', this)">수정</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteCustomer(this)">삭제</button>
                </td>
            `;

            tbody.appendChild(tr);
        }

        alert('저장 완료!');

        // 모달 닫기
        const productModalEl = document.getElementById('productModal');
        const modalInstance = bootstrap.Modal.getInstance(productModalEl);
        if (modalInstance) modalInstance.hide();

        // 폼 초기화
        form.reset();
    }

    // 상태 값 텍스트 변환 함수
    function getStatusText(status) {
        switch(status) {
            case 'ORDERED': return '주문됨';
            case 'SHIPPED': return '배송 중';
            case 'DELIVERED': return '배송 완료';
            default: return status;
        }
    }

    // 간단한 고유 ID 생성 함수 (랜덤 숫자 6자리)
    function generateUniqueId() {
        return Math.floor(100000 + Math.random() * 900000).toString();
    }

    // 삭제 함수
    function deleteCustomer(button) {
        if(confirm('정말 삭제하시겠습니까?')) {
            const tr = button.closest('tr');
            tr.remove();
        }
    }

    // 수정 함수 (기본 동작: 해당 행의 데이터를 모달에 채우고 열기)
    function editCustomer(id, button) {
        const tr = button.closest('tr');

        document.getElementById('modalTitle').textContent = '고객 수정';

        document.getElementById('productId').value = id;
        document.getElementById('customerName').value = tr.children[1].textContent;
        document.getElementById('productName').value = tr.children[2].textContent;
        document.getElementById('customerPhone').value = tr.children[3].textContent;

        // 날짜 포맷을 datetime-local에 맞게 변환
        const dateStr = tr.children[4].textContent.trim().replace(' ', 'T');
        document.getElementById('orderDate').value = dateStr;

        document.getElementById('totalPrice').value = tr.children[5].textContent;
        document.getElementById('quantity').value = tr.children[6].textContent;

        // 상태 텍스트 -> 값 변환
        const statusText = tr.children[7].textContent.trim();
        const statusValue = {
            '주문됨': 'ORDERED',
            '배송 중': 'SHIPPED',
            '배송 완료': 'DELIVERED'
        }[statusText] || 'ORDERED';
        document.getElementById('status').value = statusValue;

        const productModal = new bootstrap.Modal(document.getElementById('productModal'));
        productModal.show();
    }

    // 전화번호 입력 제어 (숫자와 하이픈만 허용)
    const phoneInput = document.getElementById('customerPhone');
    phoneInput.addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9\-]/g, '');
    });

    // 가격 입력 제어 (숫자만 허용)
    const totalPriceInput = document.getElementById('totalPrice');
    totalPriceInput.addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '');
    });

    // 페이지 로드 시 로그인 상태 확인
    document.addEventListener('DOMContentLoaded', checkLoginStatus);
</script>
</body>
</html>
